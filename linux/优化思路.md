# 每次优化前 对自己的提问

- 首先，既然要做性能优化，那要怎么判断它是不是有效呢？特别是优化后，到底能提升多少性能呢？
- 第二，性能问题通常不是独立的，如果有多个性能问题同时发生，你应该先优化哪一个呢？
- 第三，提升性能的方法并不是唯一的，当有多种方法可以选择时，你会选用哪一种呢？是不是总选那个最大程度提升性能的方法就行了呢？

答：

1. 好的应用程序是性能优化的最终目的和结果，系统优化总是为应用程序服务的。所以，必须要使用应用程序的指标，来评估性能优化的整体效果。

   系统资源的使用情况是影响应用程序性能的根源。所以，需要用系统资源的指标，来观察和分析瓶颈的来源。

2. 当性能问题有多个时，优先级问题
   先优化最重要的且最大程度提升性能的问题开始优化
   
3. 优化方法有多个时，该如何选
   综合多方面因素

在性能测试的领域，流传很广的一个说法是“二八原则”，也就是说 80% 的问题都是由 20% 的代码导致的。只要找出这 20% 的位置，你就可以优化 80% 的性能。所以，**并不是所有的性能问题都值得优化。**

# 怎么评估性能优化的效果

### 三步走理论

1. 确定性能的量化指标

   不要局限再单一维度的指标上一般从应用程序纬度和系统资源纬度分析

   比如，以 Web 应用为例：

   - 应用程序的维度，我们可以用吞吐量和请求延迟来评估应用程序的性能。
   - 系统资源的维度，我们可以用 CPU 使用率来评估系统的 CPU 使用情况

2. 测试优化前的性能指标

3. 测试性能优化后的性能指标

# CPU性能优化思路

#### 应用程序优化:排除不必要工作，只留核心逻辑

1. 减少循环次数 减少递归 减少动态没错分配
2. 编译器优化
3. 算法优化
4. 异步处理
5. 多线程代替多进程
6. 缓存

#### 系统优化

- 充分利用CPU缓存本地性，加速缓存访问;

- 控制进程的cpu使用情况，减少程序的处理速度
##### 方法

1. CPU绑定

2. CPU独占

3. 优先级调整： 使用 nice 调整进程的优先级

4. 为进程设置资源限制： 使用 Linux cgroups  来设置进程的 CPU 使用上限

5. NUMA（Non-Uniform Memory Access）优化：

     支持 NUMA 的处理器会被划分为多个 node，每个 node 都有自己的本地内存空间。NUMA 优化，其实就是让 CPU 尽可能只访问本地内存。

6. 中断负载均衡
     无论是软中断还是硬中断，它们的中断处理程序都可能会耗费大量的 CPU。开启 irqbalance 服务或者配置 smp_affinity，就可以把中断处理过程自动负载均衡到多个 CPU 上。

# 内存优化

常用的内存优化方法。比如，在需要大量内存的场景中，你就可以考虑用栈内存、内存池、HugePage 等方法，来优化内存的分配和管理。