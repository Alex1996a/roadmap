要做好监控，最核心的就是全面的、可量化的指标，这包括系统和应用两个方面。

从系统来说，监控系统要涵盖系统的整体资源使用情况，比如我们前面讲过的 CPU、内存、磁盘和文件系统、网络等各种系统资源。

而从应用程序来说，监控系统要涵盖应用程序内部的运行状态，这既包括进程的 CPU、磁盘 I/O 等整体运行状况，更需要包括诸如接口调用耗时、执行过程中的错误、内部对象的内存使用等应用程序内部的运行状况。

# 系统监控

## USE(Utilization Saturation and Errors)

[USE method](http://www.brendangregg.com/usemethod.html)把系统资源的性能指标，简化成了三个类别，即使用率、饱和度以及错误数。

- 使用率(Utilization)，表示资源用于服务的时间或容量百分比。100% 的使用率，表示容量已经用尽或者全部时间都用于服务。

- 饱和度(saturation)，表示资源的繁忙程度，通常与等待队列的长度相关。100% 的饱和度，表示资源无法接受更多的请求。

- 错误数(Errors)表示发生错误的事件个数。错误数越多，表明系统的问题越严重。

---

- 利用率/使用率：一段时间内的百分比。例如，“一个磁盘正在以90％的利用率运行”。

- 饱和度：作为队列长度。例如，“ CPU的平均运行队列长度为4”。

- 错误：标量计数。例如，“此网络接口发生了五十次后期冲突”。

![img](https://static001.geekbang.org/resource/image/cc/ee/ccd7a9350c270c0168bad6cc8d0b8aee.png)

# 应用监控的一般思路

应用程序的核心指标，不再是资源的使用情况，而是请求数、错误率和响应时间

## RED

RED方法更偏重于应用，在很多微服务中会用到。

Rate (R): The number of requests per second.
Errors (E): The number of failed requests.
Duration (D): The amount of time to process a request.

## 指标监控

有了请求数、错误率和响应时间这三个黄金指标之后，我们就可以快速知道，应用是否发生了性能问题。但是，只有这些指标显然还是不够的，因为发生性能问题后，我们还希望能够快速定位“性能瓶颈区”。所以，在我看来，下面几种指标，也是监控应用程序时必不可少的。

- **应用进程的资源使用情况**，比如进程占用的 CPU、内存、磁盘 I/O、网络等。使用过多的系统资源，导致应用程序响应缓慢或者错误数升高，是一个最常见的性能问题。

- **应用程序之间调用情况，**比如调用频率、错误数、延时等。由于应用程序并不是孤立的，如果其依赖的其他应用出现了性能问题，应用自身性能也会受到影响。

- **应用程序内部核心逻辑的运行情况**，比如关键环节的耗时以及执行过程中的错误等。由于这是应用程序内部的状态，从外部通常无法直接获取到详细的性能数据。所以，应用程序在设计和开发时，就应该把这些指标提供出来，以便监控系统可以了解其内部运行状态。

## 日志监控

性能指标的监控，可以让你迅速定位发生瓶颈的位置，不过只有指标的话往往还不够。比如，**同样的一个接口，当请求传入的参数不同时，就可能会导致完全不同的性能问题。**所以，除了指标外，我们还需要对这些指标的上下文信息进行监控，而日志正是这些上下文的最佳来源。